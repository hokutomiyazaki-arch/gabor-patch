<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    
    <!-- PWAè¨­å®š -->
    <meta name="application-name" content="ã‚¬ãƒœãƒ¼ãƒ«ãƒ‘ãƒƒãƒè¦–åŠ›å›å¾©">
    <meta name="apple-mobile-web-app-title" content="ã‚¬ãƒœãƒ¼ãƒ«ãƒ‘ãƒƒãƒ">
    
    <!-- PWA Manifest -->
    <link rel="manifest" href="manifest.json">
    
    <!-- ã‚¢ã‚¤ã‚³ãƒ³è¨­å®š -->
    <link rel="icon" href="FNT512.png">
    <link rel="apple-touch-icon" href="FNT512.png">
    <link rel="apple-touch-icon" sizes="180x180" href="FNT512.png">
    <link rel="icon" type="image/png" sizes="192x192" href="FNT512.png">
    <link rel="icon" type="image/png" sizes="512x512" href="FNT512.png">
    
    <!-- ãƒ†ãƒ¼ãƒã‚«ãƒ©ãƒ¼ -->
    <meta name="theme-color" content="#4CAF50">
    
    <title>ã‚¬ãƒœãƒ¼ãƒ«ãƒ‘ãƒƒãƒè¦–åŠ›å›å¾©ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
            -webkit-touch-callout: none;
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
        }

        html, body {
            width: 100%;
            height: 100%;
            overflow: hidden;
            position: fixed;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
        }

        body {
            touch-action: none;
            overscroll-behavior: none;
            -webkit-overflow-scrolling: touch;
            background-color: #808080;
        }

        /* ã‚¹ãƒ—ãƒ©ãƒƒã‚·ãƒ¥ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ */
        .splash-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: white;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 10000;
            opacity: 1;
            transition: opacity 0.5s ease;
        }

        .splash-screen.hide {
            opacity: 0;
            pointer-events: none;
        }

        .splash-logo {
            width: 150px;
            height: 150px;
            margin-bottom: 30px;
            background: white;
            padding: 10px;
            border-radius: 20px;
        }

        .splash-title {
            font-size: 1.5rem;
            color: #333;
            margin-bottom: 10px;
            font-weight: 600;
            text-align: center;
        }

        .splash-subtitle {
            font-size: 2rem;
            background: linear-gradient(135deg, #4CAF50 0%, #8BC34A 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            font-weight: bold;
        }

        .splash-copyright {
            position: absolute;
            bottom: 20px;
            font-size: 0.8rem;
            color: #666;
        }

        /* ãƒ¡ã‚¤ãƒ³ã‚³ãƒ³ãƒ†ãƒŠ */
        #gameContainer {
            width: 100vw;
            height: 100vh;
            position: relative;
            background-color: #808080;
            transition: background-color 0.5s;
            overflow: hidden;
        }

        /* ãƒ˜ãƒƒãƒ€ãƒ¼ï¼ˆãƒ­ã‚´ã¨èª¬æ˜ï¼‰ */
        .header {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            background: rgba(0, 0, 0, 0.9);
            color: white;
            padding: 10px;
            z-index: 3000;
            transform: translateY(0);
            transition: transform 0.3s ease;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .header.hide {
            transform: translateY(-100%);
        }

        .header-top {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 15px;
            margin-bottom: 10px;
        }

        .header-logo {
            height: 40px;
            width: auto;
            background: white;
            padding: 5px;
            border-radius: 8px;
        }

        .header-title {
            font-size: 1.2rem;
            font-weight: bold;
            background: linear-gradient(135deg, #4CAF50 0%, #8BC34A 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .header-description {
            font-size: 0.75rem;
            color: #ccc;
            text-align: center;
            line-height: 1.4;
            max-width: 90%;
            margin: 0 auto;
        }

        /* ãƒ¡ãƒ‹ãƒ¥ãƒ¼ãƒœã‚¿ãƒ³ */
        .menu-toggle {
            position: absolute;
            top: 10px;
            right: 10px;
            width: 40px;
            height: 40px;
            background: rgba(0, 0, 0, 0.7);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 4000;
            cursor: pointer;
            border: none;
            color: white;
            font-size: 20px;
        }

        /* çµ‚äº†ãƒœã‚¿ãƒ³ */
        .exit-button {
            position: absolute;
            top: 10px;
            left: 10px;
            width: auto;
            height: 40px;
            padding: 0 15px;
            background: rgba(220, 53, 69, 0.9);
            border-radius: 20px;
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 4000;
            cursor: pointer;
            border: none;
            color: white;
            font-size: 14px;
            font-weight: bold;
            gap: 5px;
        }

        .exit-button.show {
            display: flex;
        }

        .exit-button:active {
            transform: scale(0.95);
            background: rgba(200, 35, 51, 0.9);
        }

        /* UI */
        #ui {
            position: absolute;
            top: 60px;
            left: 10px;
            right: 10px;
            z-index: 1000;
            display: none;
            justify-content: space-between;
            align-items: center;
            background: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 10px 20px;
            border-radius: 10px;
            font-size: 0.9rem;
        }

        #ui.show {
            display: flex;
        }

        /* ã‚²ãƒ¼ãƒ ã‚¨ãƒªã‚¢ */
        #gameArea {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            cursor: pointer;
            touch-action: none;
        }

        /* ã‚¬ãƒœãƒ¼ãƒ«ãƒ‘ãƒƒãƒ */
        .gabor-patch {
            position: absolute;
            cursor: pointer;
            transition: opacity 0.3s;
            pointer-events: auto;
            touch-action: none;
        }

        .gabor-patch.blinking {
            animation: blink 0.5s infinite;
        }

        @keyframes blink {
            0%, 50% { opacity: 1; }
            51%, 100% { opacity: 0.3; }
        }

        /* ãƒ’ãƒƒãƒˆãƒãƒ¼ã‚«ãƒ¼ */
        .hit-marker {
            position: absolute;
            font-size: 40px;
            font-weight: bold;
            pointer-events: none;
            animation: fadeOut 0.5s forwards;
            z-index: 900;
        }

        .hit-marker.success {
            color: #00ff00;
        }

        .hit-marker.miss {
            color: #ff0000;
        }

        @keyframes fadeOut {
            0% { 
                transform: scale(1) translateY(0);
                opacity: 1;
            }
            100% { 
                transform: scale(1.5) translateY(-20px);
                opacity: 0;
            }
        }

        /* ã‚¹ã‚¿ãƒ¼ãƒˆãƒ»ã‚¨ãƒ³ãƒ‰ç”»é¢ */
        #startScreen, #endScreen {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            background-color: rgba(0, 0, 0, 0.9);
            color: white;
            z-index: 2000;
            padding: 20px;
            overflow-y: auto;
            touch-action: auto !important;
            -webkit-overflow-scrolling: touch;
        }

        #startScreen *, #endScreen * {
            touch-action: auto !important;
        }

        .game-logo {
            width: 120px;
            height: 120px;
            margin-bottom: 20px;
            background: white;
            padding: 10px;
            border-radius: 15px;
            flex-shrink: 0;
        }

        h1 {
            font-size: 1.8rem;
            margin-bottom: 20px;
            text-align: center;
            background: linear-gradient(135deg, #4CAF50 0%, #8BC34A 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .instructions {
            text-align: center;
            margin: 20px 0;
            line-height: 1.6;
            max-width: 90%;
        }

        .instructions p {
            margin: 5px 0;
            font-size: 0.9rem;
        }

        .scientific-explanation {
            background: rgba(255, 255, 255, 0.1);
            padding: 15px;
            border-radius: 10px;
            margin: 20px 0;
            max-width: 90%;
            font-size: 0.85rem;
            line-height: 1.5;
            text-align: left;
        }

        .scientific-explanation h3 {
            color: #4CAF50;
            margin-bottom: 10px;
            font-size: 1rem;
        }

        button {
            padding: 15px 40px;
            font-size: 1.2rem;
            background: linear-gradient(135deg, #4CAF50 0%, #8BC34A 100%);
            color: white;
            border: none;
            border-radius: 30px;
            cursor: pointer;
            margin-top: 20px;
            font-weight: bold;
            text-transform: uppercase;
            letter-spacing: 1px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
            transition: transform 0.2s;
        }

        button:active {
            transform: scale(0.95);
        }

        .score-display {
            font-size: 1.5rem;
            margin: 20px 0;
            text-align: center;
        }

        /* PWAã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ãƒãƒŠãƒ¼ */
        .pwa-install-banner {
            position: fixed;
            bottom: 60px;
            left: 10px;
            right: 10px;
            background: linear-gradient(135deg, #1565C0 0%, #0D47A1 100%);
            color: white;
            padding: 15px;
            border-radius: 15px;
            z-index: 5000;
            display: none;
            flex-direction: column;
            align-items: center;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
            animation: slideUp 0.3s ease;
        }

        .pwa-install-banner.show {
            display: flex;
        }

        @keyframes slideUp {
            from {
                transform: translateY(100%);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        .pwa-banner-content {
            display: flex;
            align-items: center;
            gap: 15px;
            width: 100%;
            margin-bottom: 10px;
        }

        .pwa-banner-icon {
            width: 50px;
            height: 50px;
            border-radius: 10px;
            background: white;
            padding: 5px;
            flex-shrink: 0;
        }

        .pwa-banner-text {
            flex: 1;
        }

        .pwa-banner-title {
            font-weight: bold;
            font-size: 1rem;
            margin-bottom: 3px;
        }

        .pwa-banner-description {
            font-size: 0.8rem;
            opacity: 0.9;
        }

        .pwa-banner-buttons {
            display: flex;
            gap: 10px;
            width: 100%;
        }

        .pwa-install-btn {
            flex: 1;
            padding: 12px 20px;
            background: white;
            color: #1565C0;
            border: none;
            border-radius: 25px;
            font-weight: bold;
            font-size: 0.9rem;
            cursor: pointer;
            margin: 0;
            text-transform: none;
            letter-spacing: 0;
        }

        .pwa-install-btn:active {
            background: #e0e0e0;
        }

        .pwa-close-btn {
            padding: 12px 20px;
            background: rgba(255, 255, 255, 0.2);
            color: white;
            border: none;
            border-radius: 25px;
            font-size: 0.9rem;
            cursor: pointer;
            margin: 0;
            text-transform: none;
            letter-spacing: 0;
        }

        /* iOSç”¨ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«èª¬æ˜ */
        .ios-install-guide {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.95);
            z-index: 6000;
            display: none;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            padding: 30px;
            color: white;
            text-align: center;
        }

        .ios-install-guide.show {
            display: flex;
        }

        .ios-install-guide h2 {
            font-size: 1.5rem;
            margin-bottom: 30px;
            color: #4CAF50;
        }

        .ios-install-steps {
            text-align: left;
            max-width: 300px;
        }

        .ios-step {
            display: flex;
            align-items: center;
            gap: 15px;
            margin: 20px 0;
            font-size: 1rem;
        }

        .ios-step-number {
            width: 36px;
            height: 36px;
            background: #4CAF50;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            flex-shrink: 0;
        }

        .ios-step-icon {
            font-size: 1.5rem;
        }

        .ios-close-btn {
            margin-top: 30px;
            padding: 15px 40px;
            background: #4CAF50;
            color: white;
            border: none;
            border-radius: 25px;
            font-size: 1rem;
            cursor: pointer;
        }

        /* ãƒ•ãƒƒã‚¿ãƒ¼ï¼ˆè‘—ä½œæ¨©ï¼‰ */
        .footer {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            text-align: center;
            color: rgba(255, 255, 255, 0.7);
            font-size: 0.75rem;
            z-index: 100;
            padding: 10px;
            padding-bottom: max(10px, env(safe-area-inset-bottom));
            background: rgba(0, 0, 0, 0.5);
        }

        /* ç¢ºèªãƒ€ã‚¤ã‚¢ãƒ­ã‚° */
        .confirm-dialog {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            z-index: 7000;
            display: none;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }

        .confirm-dialog.show {
            display: flex;
        }

        .confirm-box {
            background: white;
            border-radius: 20px;
            padding: 30px;
            max-width: 320px;
            width: 100%;
            text-align: center;
        }

        .confirm-title {
            font-size: 1.2rem;
            font-weight: bold;
            color: #333;
            margin-bottom: 15px;
        }

        .confirm-message {
            font-size: 0.95rem;
            color: #666;
            margin-bottom: 25px;
            line-height: 1.5;
        }

        .confirm-buttons {
            display: flex;
            gap: 10px;
        }

        .confirm-btn {
            flex: 1;
            padding: 12px 20px;
            border: none;
            border-radius: 25px;
            font-size: 1rem;
            font-weight: bold;
            cursor: pointer;
            margin: 0;
            text-transform: none;
            letter-spacing: 0;
        }

        .confirm-btn.cancel {
            background: #e0e0e0;
            color: #333;
        }

        .confirm-btn.confirm {
            background: #dc3545;
            color: white;
        }

        /* ãƒ•ãƒ«ã‚¹ã‚¯ãƒªãƒ¼ãƒ³æ™‚ã®èª¿æ•´ */
        @media screen and (max-width: 600px) {
            .header-title {
                font-size: 1rem;
            }
            
            .header-description {
                font-size: 0.7rem;
            }
            
            #ui {
                font-size: 0.8rem;
                padding: 8px 15px;
            }
            
            h1 {
                font-size: 1.5rem;
            }
            
            .instructions p {
                font-size: 0.85rem;
            }
        }

        /* æ¨ªå‘ãå¯¾å¿œ */
        @media screen and (orientation: landscape) and (max-height: 500px) {
            .header {
                padding: 5px;
            }
            
            .header-logo {
                height: 30px;
            }
            
            .header-description {
                display: none;
            }
        }

        /* Safe areaå¯¾å¿œ */
        @supports (padding: max(0px)) {
            .exit-button {
                left: max(10px, env(safe-area-inset-left));
            }
            
            .menu-toggle {
                right: max(10px, env(safe-area-inset-right));
            }
            
            #ui {
                left: max(10px, env(safe-area-inset-left));
                right: max(10px, env(safe-area-inset-right));
            }
        }
    </style>
</head>
<body>
    <!-- ã‚¹ãƒ—ãƒ©ãƒƒã‚·ãƒ¥ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ -->
    <div class="splash-screen" id="splashScreen">
        <img src="FNT512.png" alt="Logo" class="splash-logo">
        <div class="splash-title">Functional Neuro Training</div>
        <div class="splash-subtitle">ã‚¬ãƒœãƒ¼ãƒ«ãƒ‘ãƒƒãƒ</div>
        <div class="splash-copyright">Â© Functional Neuro Training</div>
    </div>

    <div id="gameContainer">
        <!-- çµ‚äº†ãƒœã‚¿ãƒ³ -->
        <button class="exit-button" id="exitButton" onclick="showExitConfirm()">
            <span>âœ•</span>
            <span>çµ‚äº†</span>
        </button>

        <!-- ãƒ¡ãƒ‹ãƒ¥ãƒ¼ãƒœã‚¿ãƒ³ -->
        <button class="menu-toggle" id="menuToggle" onclick="toggleHeader()">â˜°</button>
        
        <!-- ãƒ˜ãƒƒãƒ€ãƒ¼ -->
        <div class="header hide" id="header">
            <div class="header-top">
                <img src="FNT512-transparent.png" alt="FNT Logo" class="header-logo">
                <h2 class="header-title">ã‚¬ãƒœãƒ¼ãƒ«ãƒ‘ãƒƒãƒè¦–åŠ›å›å¾©</h2>
            </div>
            <div class="header-description">
                ã€ç¥çµŒç§‘å­¦çš„åŠ¹æœã€‘ã‚¬ãƒœãƒ¼ãƒ«ãƒ‘ãƒƒãƒã¯è¦–è¦šé‡ã®ã‚³ãƒ³ãƒˆãƒ©ã‚¹ãƒˆæ„Ÿåº¦ã‚’å‘ä¸Šã•ã›ã€
                è¦–åŠ›å›å¾©ã«åŠ¹æœçš„ã§ã™ã€‚è–„ã„ãƒ‘ãƒƒãƒã‚’è¦‹ã¤ã‘ã‚‹è¨“ç·´ã«ã‚ˆã‚Šã€
                è„³ã®è¦–è¦šå‡¦ç†èƒ½åŠ›ãŒæ”¹å–„ã•ã‚Œã¾ã™ã€‚
            </div>
        </div>

        <!-- UI -->
        <div id="ui">
            <div>ã‚¹ãƒ†ãƒ¼ã‚¸: <span id="stage">1</span> / 10</div>
            <div>æ™‚é–“: <span id="timer">60</span>ç§’</div>
            <div>ã‚¹ã‚³ã‚¢: <span id="score">0</span>ç‚¹</div>
        </div>

        <!-- ã‚²ãƒ¼ãƒ ã‚¨ãƒªã‚¢ -->
        <div id="gameArea"></div>

        <!-- ã‚¹ã‚¿ãƒ¼ãƒˆç”»é¢ -->
        <div id="startScreen">
            <img src="FNT512.png" alt="Logo" class="game-logo">
            <h1>ã‚¬ãƒœãƒ¼ãƒ«ãƒ‘ãƒƒãƒè¦–åŠ›å›å¾©ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°</h1>
            
            <div class="scientific-explanation">
                <h3>ğŸ§  ç¥çµŒç§‘å­¦çš„åŠ¹æœ</h3>
                <p>ã‚¬ãƒœãƒ¼ãƒ«ãƒ‘ãƒƒãƒãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°ã¯ã€è¦–è¦šé‡ï¼ˆV1ï¼‰ã®ãƒ‹ãƒ¥ãƒ¼ãƒ­ãƒ³æ´»å‹•ã‚’æœ€é©åŒ–ã—ã€ã‚³ãƒ³ãƒˆãƒ©ã‚¹ãƒˆæ„Ÿåº¦ã‚’å‘ä¸Šã•ã›ã¾ã™ã€‚è„³ã®è¦–è¦šå‡¦ç†èƒ½åŠ›ã‚’é›ãˆã‚‹ã“ã¨ã§ã€çœ¼çƒè‡ªä½“ã§ã¯ãªãã€Œè¦‹ã‚‹åŠ›ã€ã‚’æ”¹å–„ã—ã¾ã™ã€‚ç ”ç©¶ã§ã¯ã€ç¶™ç¶šçš„ãªãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°ã«ã‚ˆã‚Šè¦–åŠ›ã®æœ‰æ„ãªæ”¹å–„ãŒå ±å‘Šã•ã‚Œã¦ã„ã¾ã™ã€‚</p>
            </div>
            
            <div class="instructions">
                <p>ğŸ¯ éš ã‚Œã¦ã„ã‚‹ã‚¬ãƒœãƒ¼ãƒ«ãƒ‘ãƒƒãƒã‚’è¦‹ã¤ã‘ã¦ã‚¿ãƒƒãƒ</p>
                <p>âŒ èƒŒæ™¯ã‚’ã‚¿ãƒƒãƒã™ã‚‹ã¨1ç‚¹æ¸›ç‚¹</p>
                <p>ğŸ“ˆ ã‚¹ãƒ†ãƒ¼ã‚¸ãŒé€²ã‚€ã¨ãƒ‘ãƒƒãƒãŒè–„ãå°ã•ããªã‚Šã¾ã™</p>
                <p>âš¡ æ®‹ã‚Š10ç§’ã§ãƒ‘ãƒƒãƒãŒç‚¹æ»…ã—ã¾ã™</p>
            </div>
            
            <button onclick="startGame()">ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°é–‹å§‹</button>
        </div>

        <!-- çµ‚äº†ç”»é¢ -->
        <div id="endScreen" style="display: none;">
            <img src="FNT512.png" alt="Logo" class="game-logo">
            <h1>ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°çµ‚äº†</h1>
            <div class="score-display">
                <div>æœ€çµ‚ã‚¹ã‚³ã‚¢</div>
                <div style="font-size: 2.5rem; color: #4CAF50; margin-top: 10px;">
                    <span id="finalScore">0</span> / 100ç‚¹
                </div>
            </div>
            <div class="instructions">
                <p id="resultMessage"></p>
            </div>
            <button onclick="resetGame()">ã‚‚ã†ä¸€åº¦ãƒ—ãƒ¬ã‚¤</button>
        </div>

        <!-- ãƒ•ãƒƒã‚¿ãƒ¼ -->
        <div class="footer">Â© Functional Neuro Training - All Rights Reserved</div>
    </div>

    <!-- PWAã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ãƒãƒŠãƒ¼ -->
    <div class="pwa-install-banner" id="pwaInstallBanner">
        <div class="pwa-banner-content">
            <img src="FNT512.png" alt="App Icon" class="pwa-banner-icon">
            <div class="pwa-banner-text">
                <div class="pwa-banner-title">ğŸ“² ã‚¢ãƒ—ãƒªã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«</div>
                <div class="pwa-banner-description">ãƒ›ãƒ¼ãƒ ç”»é¢ã«è¿½åŠ ã—ã¦ã‚ªãƒ•ãƒ©ã‚¤ãƒ³ã§ä½¿ç”¨ã§ãã¾ã™</div>
            </div>
        </div>
        <div class="pwa-banner-buttons">
            <button class="pwa-install-btn" onclick="installPWA()">ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«</button>
            <button class="pwa-close-btn" onclick="closePWABanner()">å¾Œã§</button>
        </div>
    </div>

    <!-- iOSç”¨ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã‚¬ã‚¤ãƒ‰ -->
    <div class="ios-install-guide" id="iosInstallGuide">
        <h2>ğŸ“² ã‚¢ãƒ—ãƒªã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«æ–¹æ³•</h2>
        <div class="ios-install-steps">
            <div class="ios-step">
                <div class="ios-step-number">1</div>
                <div>ç”»é¢ä¸‹éƒ¨ã®<span class="ios-step-icon">ğŸ“¤</span>ï¼ˆå…±æœ‰ï¼‰ã‚’ã‚¿ãƒƒãƒ—</div>
            </div>
            <div class="ios-step">
                <div class="ios-step-number">2</div>
                <div>ã€Œãƒ›ãƒ¼ãƒ ç”»é¢ã«è¿½åŠ ã€ã‚’é¸æŠ</div>
            </div>
            <div class="ios-step">
                <div class="ios-step-number">3</div>
                <div>å³ä¸Šã®ã€Œè¿½åŠ ã€ã‚’ã‚¿ãƒƒãƒ—</div>
            </div>
        </div>
        <button class="ios-close-btn" onclick="closeIOSGuide()">é–‰ã˜ã‚‹</button>
    </div>

    <!-- çµ‚äº†ç¢ºèªãƒ€ã‚¤ã‚¢ãƒ­ã‚° -->
    <div class="confirm-dialog" id="confirmDialog">
        <div class="confirm-box">
            <div class="confirm-title">âš ï¸ ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°çµ‚äº†</div>
            <div class="confirm-message">ç¾åœ¨ã®ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°ã‚’çµ‚äº†ã—ã¦<br>ãƒ¡ã‚¤ãƒ³ç”»é¢ã«æˆ»ã‚Šã¾ã™ã‹ï¼Ÿ<br>é€²è¡ŒçŠ¶æ³ã¯ä¿å­˜ã•ã‚Œã¾ã›ã‚“ã€‚</div>
            <div class="confirm-buttons">
                <button class="confirm-btn cancel" onclick="hideExitConfirm()">ç¶šã‘ã‚‹</button>
                <button class="confirm-btn confirm" onclick="exitToMain()">çµ‚äº†ã™ã‚‹</button>
            </div>
        </div>
    </div>

    <script>
        // ã‚²ãƒ¼ãƒ å¤‰æ•°
        let stage = 1;
        let score = 0;
        let timeLeft = 60;
        let timer = null;
        let patches = [];
        let clearedPatches = 0;
        let perfectClear = false;
        let baseContrast = 0.08;
        let currentBackgroundColor = 128;
        let basePatchSize = { min: 60, max: 100 };
        let pendingPatches = [];
        let lastTouchTime = 0;
        let isPlaying = false;

        // PWAé–¢é€£å¤‰æ•°
        let deferredPrompt = null;
        let isPWAInstalled = false;

        // ã‚¬ãƒœãƒ¼ãƒ«ãƒ‘ãƒƒãƒã®ã‚¿ã‚¤ãƒ—
        const PATCH_TYPES = {
            STANDARD: 'standard',
            THREE_LINES: 'three_lines',
            RADIAL: 'radial',
            CIRCULAR: 'circular',
            CROSS: 'cross'
        };

        // ã‚¹ãƒ—ãƒ©ãƒƒã‚·ãƒ¥ã‚¹ã‚¯ãƒªãƒ¼ãƒ³åˆ¶å¾¡
        window.addEventListener('load', () => {
            setTimeout(() => {
                document.getElementById('splashScreen').classList.add('hide');
                // PWAã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«çŠ¶æ…‹ã‚’ãƒã‚§ãƒƒã‚¯
                checkPWAInstallState();
            }, 2000);
            
            // ã‚¢ãƒ‰ãƒ¬ã‚¹ãƒãƒ¼ã‚’éš ã™
            setTimeout(() => {
                window.scrollTo(0, 1);
            }, 100);
        });

        // PWAã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã‚¤ãƒ™ãƒ³ãƒˆ
        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            deferredPrompt = e;
            // ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ãƒãƒŠãƒ¼ã‚’è¡¨ç¤ºï¼ˆã‚¹ãƒ—ãƒ©ãƒƒã‚·ãƒ¥å¾Œï¼‰
            setTimeout(() => {
                if (!isPWAInstalled && !sessionStorage.getItem('pwaBannerDismissed')) {
                    showPWABanner();
                }
            }, 3000);
        });

        // PWAã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«å®Œäº†ã‚¤ãƒ™ãƒ³ãƒˆ
        window.addEventListener('appinstalled', () => {
            isPWAInstalled = true;
            deferredPrompt = null;
            closePWABanner();
            console.log('PWA installed successfully');
        });

        // PWAã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«çŠ¶æ…‹ãƒã‚§ãƒƒã‚¯
        function checkPWAInstallState() {
            // ã‚¹ã‚¿ãƒ³ãƒ‰ã‚¢ãƒ­ãƒ³ãƒ¢ãƒ¼ãƒ‰ã§å®Ÿè¡Œä¸­ã‹ãƒã‚§ãƒƒã‚¯
            if (window.matchMedia('(display-mode: standalone)').matches || 
                window.navigator.standalone === true) {
                isPWAInstalled = true;
                return;
            }

            // iOS Safari ã‹ã¤æœªã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã®å ´åˆ
            const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent);
            const isSafari = /Safari/.test(navigator.userAgent) && !/Chrome/.test(navigator.userAgent);
            
            if (isIOS && isSafari && !isPWAInstalled) {
                setTimeout(() => {
                    if (!sessionStorage.getItem('pwaBannerDismissed')) {
                        showPWABanner();
                    }
                }, 3000);
            }
        }

        // PWAãƒãƒŠãƒ¼è¡¨ç¤º
        function showPWABanner() {
            if (!isPlaying) {
                document.getElementById('pwaInstallBanner').classList.add('show');
            }
        }

        // PWAãƒãƒŠãƒ¼éè¡¨ç¤º
        function closePWABanner() {
            document.getElementById('pwaInstallBanner').classList.remove('show');
            sessionStorage.setItem('pwaBannerDismissed', 'true');
        }

        // PWAã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«å®Ÿè¡Œ
        function installPWA() {
            const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent);
            
            if (isIOS) {
                // iOSç”¨ã®ã‚¬ã‚¤ãƒ‰ã‚’è¡¨ç¤º
                closePWABanner();
                document.getElementById('iosInstallGuide').classList.add('show');
            } else if (deferredPrompt) {
                // Android/Chromeã®å ´åˆ
                deferredPrompt.prompt();
                deferredPrompt.userChoice.then((choiceResult) => {
                    if (choiceResult.outcome === 'accepted') {
                        console.log('PWA install accepted');
                    }
                    deferredPrompt = null;
                });
                closePWABanner();
            }
        }

        // iOSã‚¬ã‚¤ãƒ‰ã‚’é–‰ã˜ã‚‹
        function closeIOSGuide() {
            document.getElementById('iosInstallGuide').classList.remove('show');
        }

        // ãƒ˜ãƒƒãƒ€ãƒ¼ã®è¡¨ç¤º/éè¡¨ç¤º
        function toggleHeader() {
            const header = document.getElementById('header');
            header.classList.toggle('hide');
        }

        // çµ‚äº†ç¢ºèªãƒ€ã‚¤ã‚¢ãƒ­ã‚°è¡¨ç¤º
        function showExitConfirm() {
            document.getElementById('confirmDialog').classList.add('show');
        }

        // çµ‚äº†ç¢ºèªãƒ€ã‚¤ã‚¢ãƒ­ã‚°éè¡¨ç¤º
        function hideExitConfirm() {
            document.getElementById('confirmDialog').classList.remove('show');
        }

        // ãƒ¡ã‚¤ãƒ³ç”»é¢ã«æˆ»ã‚‹
        function exitToMain() {
            hideExitConfirm();
            stopTimer();
            clearPatches();
            isPlaying = false;
            
            // UIè¦ç´ ã‚’éè¡¨ç¤º
            document.getElementById('ui').classList.remove('show');
            document.getElementById('exitButton').classList.remove('show');
            
            // ã‚¹ã‚¿ãƒ¼ãƒˆç”»é¢ã‚’è¡¨ç¤º
            document.getElementById('startScreen').style.display = 'flex';
            document.getElementById('endScreen').style.display = 'none';
            
            // èƒŒæ™¯è‰²ã‚’ãƒªã‚»ãƒƒãƒˆ
            document.getElementById('gameContainer').style.backgroundColor = '#808080';
            
            // å¤‰æ•°ãƒªã‚»ãƒƒãƒˆ
            stage = 1;
            score = 0;
            clearedPatches = 0;
            perfectClear = false;
            baseContrast = 0.08;
            updateStage();
            updateScore();
        }

        // èƒŒæ™¯è‰²è¨­å®š
        function setBackgroundColor() {
            currentBackgroundColor = Math.floor(Math.random() * 60) + 98;
            const rgb = `rgb(${currentBackgroundColor}, ${currentBackgroundColor}, ${currentBackgroundColor})`;
            document.getElementById('gameContainer').style.backgroundColor = rgb;
        }

        // ãƒ‘ãƒƒãƒã‚µã‚¤ã‚ºè¨ˆç®—
        function calculatePatchSize() {
            const sizeReduction = Math.floor(score / 10) * 5;
            return {
                min: Math.max(30, basePatchSize.min - sizeReduction),
                max: Math.max(50, basePatchSize.max - sizeReduction)
            };
        }

        // ã‚¬ãƒœãƒ¼ãƒ«ãƒ‘ãƒƒãƒä½œæˆ
        function createGaborPatch(id, x, y, size, contrast, type) {
            const canvas = document.createElement('canvas');
            canvas.width = size;
            canvas.height = size;
            canvas.className = 'gabor-patch';
            canvas.dataset.id = id;
            canvas.style.left = x + 'px';
            canvas.style.top = y + 'px';
            
            const ctx = canvas.getContext('2d');
            const center = size / 2;
            const sigma = size / 6;
            const adjustedContrast = contrast * 0.6;
            
            switch(type) {
                case PATCH_TYPES.THREE_LINES:
                    drawThreeLines(ctx, size, center, sigma, adjustedContrast);
                    break;
                case PATCH_TYPES.RADIAL:
                    drawRadialPattern(ctx, size, center, sigma, adjustedContrast);
                    break;
                case PATCH_TYPES.CIRCULAR:
                    drawCircularPattern(ctx, size, center, sigma, adjustedContrast);
                    break;
                case PATCH_TYPES.CROSS:
                    drawCrossPattern(ctx, size, center, sigma, adjustedContrast);
                    break;
                default:
                    drawStandardGabor(ctx, size, center, sigma, adjustedContrast);
            }
            
            // ã‚¿ãƒƒãƒ/ã‚¯ãƒªãƒƒã‚¯ã‚¤ãƒ™ãƒ³ãƒˆ
            const isTouchDevice = 'ontouchstart' in window;
            if (isTouchDevice) {
                canvas.addEventListener('touchstart', handlePatchClick, { passive: false });
            } else {
                canvas.addEventListener('click', handlePatchClick);
            }
            
            return canvas;
        }

        // æ¨™æº–ã‚¬ãƒœãƒ¼ãƒ«ãƒ‘ãƒƒãƒæç”»
        function drawStandardGabor(ctx, size, center, sigma, contrast) {
            const frequency = 0.1;
            const theta = Math.random() * Math.PI;
            
            for (let i = 0; i < size; i++) {
                for (let j = 0; j < size; j++) {
                    const x = i - center;
                    const y = j - center;
                    
                    const gaussian = Math.exp(-(x * x + y * y) / (2 * sigma * sigma));
                    
                    if (gaussian < 0.05) {
                        ctx.fillStyle = `rgb(${currentBackgroundColor}, ${currentBackgroundColor}, ${currentBackgroundColor})`;
                        ctx.fillRect(i, j, 1, 1);
                        continue;
                    }
                    
                    const xPrime = x * Math.cos(theta) + y * Math.sin(theta);
                    const sinusoid = Math.cos(2 * Math.PI * frequency * xPrime);
                    const value = gaussian * sinusoid * contrast;
                    const gray = Math.round(currentBackgroundColor + value * 127);
                    
                    ctx.fillStyle = `rgb(${gray}, ${gray}, ${gray})`;
                    ctx.fillRect(i, j, 1, 1);
                }
            }
        }

        // 3æœ¬ç·šãƒ‘ã‚¿ãƒ¼ãƒ³
        function drawThreeLines(ctx, size, center, sigma, contrast) {
            const lineWidth = size / 10;
            const spacing = size / 4;
            const theta = Math.random() * Math.PI;
            
            for (let i = 0; i < size; i++) {
                for (let j = 0; j < size; j++) {
                    const x = i - center;
                    const y = j - center;
                    
                    const gaussian = Math.exp(-(x * x + y * y) / (2 * sigma * sigma));
                    
                    if (gaussian < 0.05) {
                        ctx.fillStyle = `rgb(${currentBackgroundColor}, ${currentBackgroundColor}, ${currentBackgroundColor})`;
                        ctx.fillRect(i, j, 1, 1);
                        continue;
                    }
                    
                    const xRot = x * Math.cos(theta) + y * Math.sin(theta);
                    
                    let value = 0;
                    for (let line = -1; line <= 1; line++) {
                        const lineCenter = line * spacing;
                        if (Math.abs(xRot - lineCenter) < lineWidth / 2) {
                            value = 1;
                        }
                    }
                    
                    value = gaussian * value * contrast;
                    const gray = Math.round(currentBackgroundColor + value * 127);
                    
                    ctx.fillStyle = `rgb(${gray}, ${gray}, ${gray})`;
                    ctx.fillRect(i, j, 1, 1);
                }
            }
        }

        // æ”¾å°„çŠ¶ãƒ‘ã‚¿ãƒ¼ãƒ³
        function drawRadialPattern(ctx, size, center, sigma, contrast) {
            const numSpokes = 8;
            
            for (let i = 0; i < size; i++) {
                for (let j = 0; j < size; j++) {
                    const x = i - center;
                    const y = j - center;
                    
                    const gaussian = Math.exp(-(x * x + y * y) / (2 * sigma * sigma));
                    
                    if (gaussian < 0.05) {
                        ctx.fillStyle = `rgb(${currentBackgroundColor}, ${currentBackgroundColor}, ${currentBackgroundColor})`;
                        ctx.fillRect(i, j, 1, 1);
                        continue;
                    }
                    
                    const angle = Math.atan2(y, x);
                    const spoke = Math.sin(angle * numSpokes);
                    const value = gaussian * spoke * contrast;
                    const gray = Math.round(currentBackgroundColor + value * 127);
                    
                    ctx.fillStyle = `rgb(${gray}, ${gray}, ${gray})`;
                    ctx.fillRect(i, j, 1, 1);
                }
            }
        }

        // å††å½¢ãƒ‘ã‚¿ãƒ¼ãƒ³
        function drawCircularPattern(ctx, size, center, sigma, contrast) {
            const frequency = 0.15;
            
            for (let i = 0; i < size; i++) {
                for (let j = 0; j < size; j++) {
                    const x = i - center;
                    const y = j - center;
                    const r = Math.sqrt(x * x + y * y);
                    
                    const gaussian = Math.exp(-(r * r) / (2 * sigma * sigma));
                    
                    if (gaussian < 0.05) {
                        ctx.fillStyle = `rgb(${currentBackgroundColor}, ${currentBackgroundColor}, ${currentBackgroundColor})`;
                        ctx.fillRect(i, j, 1, 1);
                        continue;
                    }
                    
                    const circular = Math.cos(2 * Math.PI * frequency * r);
                    const value = gaussian * circular * contrast;
                    const gray = Math.round(currentBackgroundColor + value * 127);
                    
                    ctx.fillStyle = `rgb(${gray}, ${gray}, ${gray})`;
                    ctx.fillRect(i, j, 1, 1);
                }
            }
        }

        // ã‚¯ãƒ­ã‚¹ãƒ‘ã‚¿ãƒ¼ãƒ³
        function drawCrossPattern(ctx, size, center, sigma, contrast) {
            const lineWidth = size / 8;
            
            for (let i = 0; i < size; i++) {
                for (let j = 0; j < size; j++) {
                    const x = i - center;
                    const y = j - center;
                    
                    const gaussian = Math.exp(-(x * x + y * y) / (2 * sigma * sigma));
                    
                    if (gaussian < 0.05) {
                        ctx.fillStyle = `rgb(${currentBackgroundColor}, ${currentBackgroundColor}, ${currentBackgroundColor})`;
                        ctx.fillRect(i, j, 1, 1);
                        continue;
                    }
                    
                    const inCross = (Math.abs(x) < lineWidth / 2) || (Math.abs(y) < lineWidth / 2);
                    const value = gaussian * (inCross ? 1 : 0) * contrast;
                    const gray = Math.round(currentBackgroundColor + value * 127);
                    
                    ctx.fillStyle = `rgb(${gray}, ${gray}, ${gray})`;
                    ctx.fillRect(i, j, 1, 1);
                }
            }
        }

        // ãƒ‘ãƒƒãƒã‚¯ãƒªãƒƒã‚¯å‡¦ç†
        function handlePatchClick(e) {
            e.preventDefault();
            e.stopPropagation();
            
            const currentTime = Date.now();
            if (currentTime - lastTouchTime < 100) return;
            lastTouchTime = currentTime;
            
            const patch = e.target;
            const rect = patch.getBoundingClientRect();
            
            // â—‹ãƒãƒ¼ã‚¯ã‚’è¡¨ç¤º
            const marker = document.createElement('div');
            marker.className = 'hit-marker success';
            marker.textContent = 'â—‹';
            marker.style.left = (rect.left + rect.width / 2 - 20) + 'px';
            marker.style.top = (rect.top + rect.height / 2 - 20) + 'px';
            document.getElementById('gameContainer').appendChild(marker);
            
            patch.remove();
            clearedPatches++;
            score++;
            updateScore();
            
            setTimeout(() => marker.remove(), 500);
            
            if (pendingPatches.length > 0) {
                setTimeout(() => tryPlacePendingPatches(), 100);
            }
            
            if (clearedPatches === 10) {
                perfectClear = true;
                nextStage();
            }
        }

        // èƒŒæ™¯ã‚¯ãƒªãƒƒã‚¯å‡¦ç†
        function handleBackgroundClick(e) {
            if (e.target.classList.contains('gabor-patch')) return;
            if (e.target.id === 'menuToggle' || e.target.closest('.header')) return;
            if (e.target.id === 'exitButton' || e.target.closest('.exit-button')) return;
            if (e.target.closest('.confirm-dialog')) return;
            
            const currentTime = Date.now();
            if (currentTime - lastTouchTime < 100) return;
            lastTouchTime = currentTime;
            
            // Ã—ãƒãƒ¼ã‚¯ã‚’è¡¨ç¤º
            const marker = document.createElement('div');
            marker.className = 'hit-marker miss';
            marker.textContent = 'Ã—';
            
            const clientX = e.touches ? e.touches[0].clientX : e.clientX;
            const clientY = e.touches ? e.touches[0].clientY : e.clientY;
            
            marker.style.left = (clientX - 20) + 'px';
            marker.style.top = (clientY - 20) + 'px';
            document.getElementById('gameContainer').appendChild(marker);
            
            score = Math.max(0, score - 1);
            updateScore();
            
            setTimeout(() => marker.remove(), 500);
        }

        // ãƒ‘ãƒƒãƒç”Ÿæˆ
        function generatePatches() {
            const gameArea = document.getElementById('gameArea');
            const types = Object.values(PATCH_TYPES);
            const sizeRange = calculatePatchSize();
            const placedPatches = [];
            pendingPatches = [];
            
            for (let i = 0; i < 10; i++) {
                const size = Math.random() * (sizeRange.max - sizeRange.min) + sizeRange.min;
                const contrast = baseContrast * (Math.random() * 0.3 + 0.7);
                const type = types[Math.floor(Math.random() * types.length)];
                
                let x, y;
                let attempts = 0;
                const maxAttempts = 50;
                let placed = false;
                
                do {
                    x = Math.random() * (window.innerWidth - size);
                    y = Math.random() * (window.innerHeight - size - 120) + 110;
                    attempts++;
                    
                    if (!isOverlapping(x, y, size, placedPatches)) {
                        placed = true;
                        break;
                    }
                } while (attempts < maxAttempts);
                
                if (placed) {
                    placedPatches.push({ x, y, size });
                    const patch = createGaborPatch(i, x, y, size, contrast, type);
                    gameArea.appendChild(patch);
                    patches.push(patch);
                } else {
                    pendingPatches.push({ id: i, size, contrast, type });
                }
            }
        }

        // å¾…æ©Ÿãƒ‘ãƒƒãƒé…ç½®è©¦è¡Œ
        function tryPlacePendingPatches() {
            if (pendingPatches.length === 0) return;
            
            const gameArea = document.getElementById('gameArea');
            const placedPatches = [];
            
            document.querySelectorAll('.gabor-patch').forEach(patch => {
                const rect = patch.getBoundingClientRect();
                placedPatches.push({
                    x: rect.left,
                    y: rect.top,
                    size: rect.width
                });
            });
            
            const stillPending = [];
            
            for (const pending of pendingPatches) {
                let x, y;
                let attempts = 0;
                const maxAttempts = 50;
                let placed = false;
                
                do {
                    x = Math.random() * (window.innerWidth - pending.size);
                    y = Math.random() * (window.innerHeight - pending.size - 120) + 110;
                    attempts++;
                    
                    if (!isOverlapping(x, y, pending.size, placedPatches)) {
                        placed = true;
                        break;
                    }
                } while (attempts < maxAttempts);
                
                if (placed) {
                    placedPatches.push({ x, y, size: pending.size });
                    const patch = createGaborPatch(pending.id, x, y, pending.size, pending.contrast, pending.type);
                    gameArea.appendChild(patch);
                    patches.push(patch);
                    
                    if (timeLeft <= 10) {
                        patch.classList.add('blinking');
                    }
                } else {
                    stillPending.push(pending);
                }
            }
            
            pendingPatches = stillPending;
        }

        // é‡ãªã‚Šãƒã‚§ãƒƒã‚¯
        function isOverlapping(x, y, size, placedPatches) {
            const margin = 10;
            
            for (const placed of placedPatches) {
                const dx = x - placed.x;
                const dy = y - placed.y;
                
                if (Math.abs(dx) < size / 2 + placed.size / 2 + margin &&
                    Math.abs(dy) < size / 2 + placed.size / 2 + margin) {
                    return true;
                }
            }
            
            return false;
        }

        // ãƒ‘ãƒƒãƒã‚¯ãƒªã‚¢
        function clearPatches() {
            patches.forEach(patch => {
                if (patch.parentNode) {
                    patch.remove();
                }
            });
            patches = [];
        }

        // ã‚¿ã‚¤ãƒãƒ¼é–‹å§‹
        function startTimer() {
            timeLeft = 60;
            updateTimer();
            
            timer = setInterval(() => {
                timeLeft--;
                updateTimer();
                
                if (timeLeft === 10) {
                    document.querySelectorAll('.gabor-patch').forEach(patch => {
                        patch.classList.add('blinking');
                    });
                }
                
                if (timeLeft === 0) {
                    document.querySelectorAll('.gabor-patch').forEach(patch => {
                        const rect = patch.getBoundingClientRect();
                        const marker = document.createElement('div');
                        marker.className = 'hit-marker miss';
                        marker.textContent = 'Ã—';
                        marker.style.left = (rect.left + rect.width / 2 - 20) + 'px';
                        marker.style.top = (rect.top + rect.height / 2 - 20) + 'px';
                        document.getElementById('gameContainer').appendChild(marker);
                        
                        setTimeout(() => marker.remove(), 1000);
                    });
                    
                    setTimeout(() => {
                        nextStage();
                    }, 1000);
                }
            }, 1000);
        }

        // ã‚¿ã‚¤ãƒãƒ¼åœæ­¢
        function stopTimer() {
            if (timer) {
                clearInterval(timer);
                timer = null;
            }
        }

        // UIæ›´æ–°
        function updateTimer() {
            document.getElementById('timer').textContent = timeLeft;
        }

        function updateScore() {
            document.getElementById('score').textContent = score;
        }

        function updateStage() {
            document.getElementById('stage').textContent = stage;
        }

        // æ¬¡ã®ã‚¹ãƒ†ãƒ¼ã‚¸
        function nextStage() {
            stopTimer();
            clearPatches();
            
            if (perfectClear) {
                baseContrast *= 0.9;
            }
            
            clearedPatches = 0;
            perfectClear = false;
            
            if (stage < 10) {
                stage++;
                updateStage();
                setBackgroundColor();
                generatePatches();
                startTimer();
            } else {
                endGame();
            }
        }

        // ã‚²ãƒ¼ãƒ é–‹å§‹
        function startGame() {
            document.getElementById('startScreen').style.display = 'none';
            document.getElementById('header').classList.add('hide');
            document.getElementById('ui').classList.add('show');
            document.getElementById('exitButton').classList.add('show');
            
            // PWAãƒãƒŠãƒ¼ã‚’éè¡¨ç¤º
            closePWABanner();
            
            isPlaying = true;
            
            const isTouchDevice = 'ontouchstart' in window;
            if (isTouchDevice) {
                document.getElementById('gameArea').addEventListener('touchstart', handleBackgroundClick, { passive: false });
            } else {
                document.getElementById('gameArea').addEventListener('click', handleBackgroundClick);
            }
            
            stage = 1;
            score = 0;
            clearedPatches = 0;
            perfectClear = false;
            baseContrast = 0.08;
            updateStage();
            updateScore();
            setBackgroundColor();
            generatePatches();
            startTimer();
        }

        // ã‚²ãƒ¼ãƒ çµ‚äº†
        function endGame() {
            isPlaying = false;
            document.getElementById('ui').classList.remove('show');
            document.getElementById('exitButton').classList.remove('show');
            
            document.getElementById('finalScore').textContent = score;
            
            let message = "";
            if (score >= 90) {
                message = "ğŸ† ç´ æ™´ã‚‰ã—ã„ï¼è¦–è¦šèªè­˜èƒ½åŠ›ãŒéå¸¸ã«é«˜ã„ã§ã™ï¼";
            } else if (score >= 70) {
                message = "ğŸŒŸ ã¨ã¦ã‚‚è‰¯ã„çµæœã§ã™ï¼ç¶™ç¶šçš„ãªãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°ã§æ›´ã«å‘ä¸Šã—ã¾ã™ã€‚";
            } else if (score >= 50) {
                message = "ğŸ‘ è‰¯ã„æˆç¸¾ã§ã™ï¼æ¯æ—¥ã®ç·´ç¿’ã§è¦–åŠ›æ”¹å–„ãŒæœŸå¾…ã§ãã¾ã™ã€‚";
            } else {
                message = "ğŸ’ª ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°ã‚’ç¶šã‘ã‚‹ã“ã¨ã§è¦–è¦šèƒ½åŠ›ãŒå‘ä¸Šã—ã¾ã™ã€‚";
            }
            
            document.getElementById('resultMessage').textContent = message;
            document.getElementById('endScreen').style.display = 'flex';
        }

        // ã‚²ãƒ¼ãƒ ãƒªã‚»ãƒƒãƒˆ
        function resetGame() {
            document.getElementById('endScreen').style.display = 'none';
            document.getElementById('startScreen').style.display = 'flex';
            clearPatches();
            stopTimer();
            document.getElementById('gameContainer').style.backgroundColor = '#808080';
        }

        // Service Workerç™»éŒ²
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('./sw.js')
                    .then(registration => {
                        console.log('Service Worker registered');
                        
                        // æ›´æ–°ãƒã‚§ãƒƒã‚¯
                        registration.addEventListener('updatefound', () => {
                            const newWorker = registration.installing;
                            newWorker.addEventListener('statechange', () => {
                                if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
                                    // æ–°ã—ã„ãƒãƒ¼ã‚¸ãƒ§ãƒ³ãŒåˆ©ç”¨å¯èƒ½
                                    if (confirm('æ–°ã—ã„ãƒãƒ¼ã‚¸ãƒ§ãƒ³ãŒåˆ©ç”¨å¯èƒ½ã§ã™ã€‚æ›´æ–°ã—ã¾ã™ã‹ï¼Ÿ')) {
                                        newWorker.postMessage({ type: 'SKIP_WAITING' });
                                        window.location.reload();
                                    }
                                }
                            });
                        });
                    })
                    .catch(err => console.log('Service Worker registration failed:', err));
            });
        }

        // ã‚¢ãƒ‰ãƒ¬ã‚¹ãƒãƒ¼ã‚’éš ã™
        window.addEventListener('scroll', () => {
            if (window.scrollY < 1) {
                setTimeout(() => {
                    window.scrollTo(0, 1);
                }, 0);
            }
        });

        // æ¨ªã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«é˜²æ­¢
        document.addEventListener('touchmove', (e) => {
            if (e.touches.length > 1) {
                e.preventDefault();
            }
        }, { passive: false });

        // ãƒ“ãƒ¥ãƒ¼ãƒãƒ¼ãƒˆå›ºå®š
        window.addEventListener('scroll', () => {
            if (window.scrollX > 0) {
                window.scrollTo(0, window.scrollY);
            }
        });

        // ãƒ•ã‚©ãƒ¼ã‚«ã‚¹æ™‚ã®ã‚ºãƒ¼ãƒ é˜²æ­¢
        document.addEventListener('gesturestart', (e) => {
            e.preventDefault();
        });
    </script>
</body>
</html>
